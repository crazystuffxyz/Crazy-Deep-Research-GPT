import{escapeHtml,renderContent,scrollToBottom,generateUniqueId}from"./utils.js";import{ICONS,MODE_HEAVY_DUTY_DEEP_RESEARCH,HEAVY_DUTY_RESEARCH_STORAGE_PREFIX}from"./constants.js";import{getFaviconUrl,prependFaviconToElement}from"./faviconHandler.js";import{appSettings,loadAppSettings}from"./settingsHandler.js";import{getCurrentSession,getAIMessageLog,updateAIMessageLog,saveSessions}from"./sessionManager.js";import{saveHeavyDutyProgress,loadHeavyDutyProgressForMessage,updateHeavyDutyProcessedData,clearHeavyDutyProgress}from"./heavyDutyResearchPersistence.js";import{sendWsMessage}from"./websocketClient.js";let chatWindowEl,welcomeMessageEl,userInputEl,sendBtnEl,modeSelectEl,aiMessageTemplate,localPrimaryModelSelectorEl,localAuxModelSelectorEl,localAvailableModelsListEl,currentAIBubble=null,isAIResponding=!1,stoppedMessageIds=new Set;export function initUIManagerDOM(e){chatWindowEl=e.chatWindowEl,welcomeMessageEl=e.welcomeMessageEl,userInputEl=e.userInputEl,sendBtnEl=e.sendBtnEl,modeSelectEl=e.modeSelectEl,aiMessageTemplate=e.aiMessageTemplate,localPrimaryModelSelectorEl=e.primaryModelSelectorEl,localAuxModelSelectorEl=e.auxModelSelectorEl,localAvailableModelsListEl=e.availableModelsListEl,chatWindowEl?chatWindowEl.addEventListener("click",handleMessageActions):console.error("CRITICAL ERROR: chatWindowEl is null in initUIManagerDOM. Chat interactions will fail. Ensure the HTML element with ID 'chat-window' exists and is loaded.")}export function getIsAIResponding(){return isAIResponding}export function getCurrentAIBubble(){return currentAIBubble}export function setCurrentAIBubble(e){currentAIBubble=e}export function clearStoppedMessageIds(){stoppedMessageIds.clear()}export function showWelcomeMessage(e=!0){welcomeMessageEl&&(welcomeMessageEl.style.display=e?"block":"none")}export function clearChatWindow(){chatWindowEl&&(chatWindowEl.innerHTML="")}export async function renderThinkingProcess(e,t,s=!1,n=!1){const a=t.querySelector(".thinking-process-details"),o=t.querySelector(".thinking-log-container"),r=t.querySelector(".summary-text");if(!a||!o||!r)return;let i="";"string"==typeof e?i=e:"object"==typeof e&&null!==e&&"string"==typeof e.currentLog?i=e.currentLog:"object"==typeof e&&null!==e&&(i=e.currentLog||"",""===i&&e.status&&(i+=`Status: ${e.status}${e.detail?`\nDetail: ${e.detail}`:""}\n`),e.error&&!i.includes(`Error: ${e.error}`)&&(i+=`Error: ${e.error}\n`));const l=""!==i.trim();a.classList.toggle("hidden",!l&&!s&&!n),o.innerHTML="";const d=i.split("\n").filter((e=>e.trim()));for(const e of d){const t=document.createElement("div");t.className="flex items-start space-x-1.5 py-0.5";let s=ICONS.info,n=escapeHtml(e),a=null;e.match(/searchUp|SERP Query|search results/i)?s=ICONS.search:e.match(/Fetching URL|Fetching Content|Fetched Content|Processing Link|Fetching:/i)?s=ICONS.fetch:e.match(/Summariz|Generating Citation|generateCitationAndSummary/i)?s=ICONS.summarize:e.match(/^Research Update:/i)?s=ICONS.update||ICONS.info:e.match(/Error Generating|Error Fetching|Error Searching|Error Processing Link|Error determining mode/i)?s=ICONS.error:e.match(/Warning/i)?s=ICONS.warn:e.match(/Generating (Final Report|research paper|SERP Queries)|Synthesizing paper/i)?s=ICONS.generate:e.match(/Complete|Max Depth Reached|Finished reading|Mode Determined|Transcript Fetched/i)?s=ICONS.complete:e.match(/Stopped by user/i)?s=ICONS.stopped:e.match(/YouTube Transcript|Fetching transcript/i)?s=ICONS.youtube:e.match(/Determining best mode|Auto Mode/i)?s=ICONS.auto:e.match(/Resuming Heavy Duty Research/i)&&(s=ICONS.resume);const r=e.match(/(?:searchUp|Query):\s*"((?:[^"\\]|\\.)*)"/i);r&&r[1]&&(n=`${escapeHtml(e.substring(0,r.index))} <code class="text-sky-700 bg-sky-50 px-1 py-0.5 rounded">${escapeHtml(r[1])}</code>${escapeHtml(e.substring(r.index+r[0].length))}`);const i=/(https?:\/\/[^\s]+)/;let l=e;if(e.startsWith("Research Update: Processed data for: ")||e.startsWith("Research Update: Marked as visited: ")){const t=e.indexOf("http");-1!==t&&(l=e.substring(t))}const d=l.match(i);if(d&&d[0]&&(e.match(/Fetching URL|Fetching Content|Fetched Content|URL:|Fetching:|Research Update:/i)||e.match(/youtube\.com|youtu\.be/i))){a=d[0];const t=e.indexOf(d[0]);-1!==t&&(n=`${escapeHtml(e.substring(0,t))}<a href="${escapeHtml(d[0])}" target="_blank" rel="noopener noreferrer" class="text-violet-600 hover:underline">${escapeHtml(d[0])}</a>${escapeHtml(e.substring(t+d[0].length))}`)}const c=document.createElement("span");if(c.className="flex-grow leading-tight",c.innerHTML=n,t.innerHTML=s,t.appendChild(c),o.appendChild(t),a)try{const e=new URL(a).hostname;getFaviconUrl(a).then((s=>{s&&prependFaviconToElement(t,s,e)})).catch((e=>console.warn(`[Favicon] Error in getFaviconUrl promise for ${a}:`,e)))}catch(e){}}"function"==typeof window.renderKatex&&window.renderKatex(o),n?(r.textContent="Process Stopped",a.setAttribute("open","")):s||i.match(/Complete|Finished|Mode Determined|Transcript Fetched/i)?r.textContent="View Process Log":(r.textContent="Thinking...",l&&a.setAttribute("open",""))}export function createMessageElement(e,t,s,n=null){let a;const o=(new Date).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"});if("user"===e){a=document.createElement("div"),a.className="flex w-full mt-2 space-x-3 max-w-xl lg:max-w-2xl ml-auto justify-end group message-container",a.dataset.messageId=s,n&&(a.dataset.sessionId=n);const e=document.createElement("div");e.className="bg-blue-600 text-white p-3 rounded-l-lg rounded-br-lg shadow-sm";const r=document.createElement("p");r.className="text-sm",renderContent(t,r),e.appendChild(r);const i=document.createElement("div");i.className="flex justify-end items-center space-x-2 mt-1";const l=document.createElement("div");l.className="message-actions flex space-x-1",l.innerHTML=`<button title="Delete" class="delete-msg-btn p-0.5 hover:bg-blue-700 rounded" data-message-id="${s}"><svg class="w-3 h-3 text-blue-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>`,i.appendChild(l);const d=document.createElement("span");d.className="text-xs text-blue-200 px-1",d.textContent=o,i.appendChild(d);const c=document.createElement("div");c.appendChild(e),c.appendChild(i);const u=document.createElement("div");u.className="flex-shrink-0 h-8 w-8 rounded-full bg-slate-300 flex items-center justify-center",u.innerHTML='<svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',a.appendChild(c),a.appendChild(u)}else{a=aiMessageTemplate.content.cloneNode(!0).querySelector(".message-container"),a.dataset.messageId=s,n&&(a.dataset.sessionId=n),getAIMessageLog(s)||updateAIMessageLog(s,{fullThinkingLog:"",lastStatus:"",isComplete:!1,isStopped:!1}),updateAIBubble(a,t,s);const e=a.querySelector(".delete-msg-btn");e&&(e.dataset.messageId=s);const o=a.querySelector(".stop-generation-btn");o&&(o.dataset.messageId=s)}return a}export function updateAIBubble(e,t,s){const n=e.querySelector(".final-response"),a=e.querySelector(".response-loader"),o=e.querySelector(".timestamp"),r=e.querySelector(".stop-generation-btn");let i=getAIMessageLog(s)||{fullThinkingLog:"",finalResponse:"",lastStatus:"",isComplete:!1,isStopped:!1};if(i.isStopped&&(!t||!t._isAIMessageObject))return renderThinkingProcess(i.fullThinkingLog,e,i.isComplete,!0),void(r&&r.classList.remove("active"));let l=i.finalResponse||"",d=i.isComplete;if("object"==typeof t&&null!==t&&t._isAIMessageObject)l=t.finalResponse||"",i.fullThinkingLog=t.thinkingLog||"",d=!0===t.isComplete,i.isComplete=d,i.isStopped=!0===t.isStopped,i.heavyDutyResearchId=t.heavyDutyResearchId;else if("object"==typeof t&&null!==t){if(t.thinking){const e=t.thinking.trim();e&&!i.fullThinkingLog.endsWith(e)&&(i.fullThinkingLog=(i.fullThinkingLog?i.fullThinkingLog+"\n":"")+e,i.lastStatus=e.split("\n").pop()||i.lastStatus)}if(t.response&&(l=t.response),t.heavyDutyResearchUpdate&&i.heavyDutyResearchId){let e="";if(t.heavyDutyResearchUpdate.statusDetail?e=t.heavyDutyResearchUpdate.statusDetail:t.heavyDutyResearchUpdate.processedDataChunk?e=`Processed data for: ${t.heavyDutyResearchUpdate.processedDataChunk.url}`:t.heavyDutyResearchUpdate.visitedUrl&&(e=`Marked as visited: ${t.heavyDutyResearchUpdate.visitedUrl}`),e){const t=`Research Update: ${e}`;i.fullThinkingLog.endsWith(t)||(i.fullThinkingLog=(i.fullThinkingLog?i.fullThinkingLog+"\n":"")+t)}t.heavyDutyResearchUpdate.processedDataChunk&&updateHeavyDutyProcessedData(i.heavyDutyResearchId,t.heavyDutyResearchUpdate.processedDataChunk,t.heavyDutyResearchUpdate.processedDataChunk.url),t.heavyDutyResearchUpdate.visitedUrl&&updateHeavyDutyProcessedData(i.heavyDutyResearchId,null,t.heavyDutyResearchUpdate.visitedUrl)}if(t.status){const e=`Status: ${t.status}${t.detail?`\nDetail: ${t.detail}`:""}${t.error?`\nError: ${t.error}`:""}`,s=i.lastStatus?i.lastStatus.replace(/\n/g," ").trim():"",n=e.replace(/\n/g," ").trim();if(s!==n&&(i.fullThinkingLog=(i.fullThinkingLog?i.fullThinkingLog+"\n":"")+e,i.lastStatus=n),t.determinedModeInfo){const e=`\nAuto-Mode determined: ${t.determinedModeInfo.name}. Reason: ${t.determinedModeInfo.reason||"N/A"}`;i.fullThinkingLog.includes(e.trim())||(i.fullThinkingLog+=e)}if(t.youtubeTranscript){const e="\nYouTube Transcript successfully fetched.";i.fullThinkingLog.includes(e.trim())||(i.fullThinkingLog+=e)}}if(t.finalResult){d=!0,l=`## Research Paper\n\n${t.finalResult.researchPaper}\n\n## Works Cited\n\n${t.finalResult.citations}`;const e="\nStatus: Complete\nDetail: Research paper and citations generated.";i.fullThinkingLog.includes(e.trim())||(i.fullThinkingLog+=e),i.lastStatus="Complete",i.heavyDutyResearchId&&clearHeavyDutyProgress(i.heavyDutyResearchId)}else if(void 0===t.thinking&&void 0===t.response&&!t.status&&!t.heavyDutyResearchUpdate){const e=`Warning: Received unhandled object structure: ${JSON.stringify(t)}`;i.fullThinkingLog.includes(e.substring(0,100))||(i.fullThinkingLog=(i.fullThinkingLog?i.fullThinkingLog+"\n":"")+e),console.warn("Unhandled WS object structure in updateAIBubble:",t)}"boolean"==typeof t.isFinal&&(d=t.isFinal,d&&i.heavyDutyResearchId&&!t.finalResult&&clearHeavyDutyProgress(i.heavyDutyResearchId))}else"string"==typeof t&&(l=t,i.fullThinkingLog="",d=!0,i.heavyDutyResearchId&&clearHeavyDutyProgress(i.heavyDutyResearchId));i.isComplete=d,i.finalResponse=l,updateAIMessageLog(s,{...i}),renderThinkingProcess(i.fullThinkingLog,e,d,i.isStopped),l||d||i.isStopped?(a.classList.add("hidden"),renderContent(l,n)):(a.classList.remove("hidden"),n.innerHTML=""),o.textContent=(new Date).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}),r&&r.classList.toggle("active",!d&&!i.isStopped&&e===currentAIBubble);const c=e.querySelector(".resume-hd-research-btn");!i.heavyDutyResearchId||d||i.isStopped?c&&(c.style.display="none"):c?c.style.display="inline-flex":addResumeButtonToMessage(e,s,i.heavyDutyResearchId),(d||i.isStopped)&&currentAIBubble&&currentAIBubble.dataset.messageId===s&&(setAIResponding(!1),currentAIBubble=null);const u=getCurrentSession();if(u?.messages){const e=u.messages.findIndex((e=>e.id===s));if(-1!==e){let s=null;t&&"object"==typeof t&&(t._isAIMessageObject?s=t.originalStatusData:t.status&&(s={status:t.status,detail:t.detail,error:t.error})),u.messages[e].text={_isAIMessageObject:!0,thinkingLog:i.fullThinkingLog,finalResponse:l,isComplete:d,isStopped:i.isStopped,originalStatusData:s,heavyDutyResearchId:i.heavyDutyResearchId},saveSessions()}}}export function setAIResponding(e){if(isAIResponding=e,userInputEl&&(userInputEl.disabled=isAIResponding),sendBtnEl&&(sendBtnEl.disabled=userInputEl&&""===userInputEl.value.trim()||isAIResponding),modeSelectEl&&(modeSelectEl.disabled=isAIResponding),isAIResponding&&currentAIBubble){const e=currentAIBubble.querySelector(".stop-generation-btn");e&&e.classList.add("active")}else if(!isAIResponding&&chatWindowEl){chatWindowEl.querySelectorAll(".stop-generation-btn.active").forEach((e=>e.classList.remove("active")))}}export function appendMessageToChatWindow(e,t,s=null,n=null){showWelcomeMessage(!1);const a=createMessageElement(e,t,s||generateUniqueId(),n||getCurrentSession()?.id);return chatWindowEl&&(chatWindowEl.appendChild(a),scrollToBottom(chatWindowEl)),a}function handleMessageActions(e){const t=e.target.closest("button");if(!t)return;const s=t.dataset.messageId;if(!s)return;const n=getCurrentAIBubble();if(t.classList.contains("delete-msg-btn")){if(isAIResponding&&n&&n.dataset.messageId===s){if(!confirm("The AI is currently responding. Deleting it will also stop the response. Continue?"))return;stopAIMessageGeneration(s,!0)}deleteMessageFromUIAndSession(s)}else if(t.classList.contains("stop-generation-btn"))stopAIMessageGeneration(s);else if(t.classList.contains("resume-hd-research-btn")){resumeHeavyDutyResearch(s,t.dataset.researchId)}}function stopAIMessageGeneration(e,t=!1){const s=chatWindowEl.querySelector(`.message-container[data-message-id="${e}"]`);let n=getCurrentAIBubble();if(!s)return console.warn("Stop called for non-existent AI bubble DOM element with ID:",e),void(n&&n.dataset.messageId===e&&(setAIResponding(!1),setCurrentAIBubble(null)));const a=getAIMessageLog(e);if(!a)return console.warn("Stop called, but no log entry found for AI bubble:",e),n&&n.dataset.messageId===e&&(setAIResponding(!1),setCurrentAIBubble(null)),void updateAIBubble(s,{_isAIMessageObject:!0,isStopped:!0,isComplete:!0,thinkingLog:"Status: Stopped by user (no prior log).\n",finalResponse:""},e);a.isStopped=!0,a.isComplete=!0,a.fullThinkingLog=(a.fullThinkingLog||"")+"\nStatus: Stopped by user.\n",updateAIMessageLog(e,a),updateAIBubble(s,{_isAIMessageObject:!0,...a},e),n&&n.dataset.messageId===e&&(stoppedMessageIds.add(e),setAIResponding(!1),setCurrentAIBubble(null)),a.heavyDutyResearchId&&clearHeavyDutyProgress(a.heavyDutyResearchId),t||saveSessions()}function deleteMessageFromUIAndSession(e){const t=getCurrentSession();if(!t||!t.messages)return;const s=t.messages.findIndex((t=>t.id===e));if(-1===s)return;const n=getCurrentAIBubble();if(isAIResponding&&n&&n.dataset.messageId===e);else if(!confirm("Are you sure you want to delete this message?"))return;const a=t.messages[s];"ai"===a.role&&a.text?._isAIMessageObject?.heavyDutyResearchId&&clearHeavyDutyProgress(a.text.heavyDutyResearchId);getAIMessageLog(e);t.messages.splice(s,1),saveSessions();const o=chatWindowEl.querySelector(`.message-container[data-message-id="${e}"], div[data-message-id="${e}"]`);o&&o.remove(),n&&n.dataset.messageId===e&&!isAIResponding&&setCurrentAIBubble(null),0===t.messages.length&&showWelcomeMessage(!0)}export async function populateModelSelectors(e,t,s){const n=e||localPrimaryModelSelectorEl,a=t||localAuxModelSelectorEl,o=s||localAvailableModelsListEl;try{const e=await fetch("/api/ollama/models");if(!e.ok)throw new Error(`Failed to fetch models: ${e.statusText}`);const t=await e.json();o&&(o.innerHTML=""),n&&(n.innerHTML='<option value="">Default</option>'),a&&(a.innerHTML='<option value="">Default</option>'),t&&t.length>0?t.forEach((e=>{const t=document.createElement("option");if(t.value=e.name,t.textContent=e.name,n&&n.appendChild(t.cloneNode(!0)),a&&a.appendChild(t.cloneNode(!0)),o){const t=document.createElement("li");t.className="text-slate-600 py-0.5",t.textContent=e.name,o.appendChild(t)}})):o&&(o.innerHTML="<li>No local models found or Ollama not accessible.</li>"),loadAppSettings()}catch(e){console.error("Error populating model selectors:",e),o&&(o.innerHTML=`<li>Error loading models: ${e.message}</li>`),n&&(n.innerHTML='<option value="">Error loading</option>'),a&&(a.innerHTML='<option value="">Error loading</option>'),loadAppSettings()}}export function handleWSMessage(e,t,s,n){let a=t();if(!a&&!isAIResponding)return void console.warn("Received WebSocket message but no current AI bubble is active and not expecting response.");if(!a&&isAIResponding){console.warn("isAIResponding is true, but currentAIBubble is null. This is unexpected during message handling. Attempting to find last active bubble.");const e=chatWindowEl.querySelectorAll(".message-container[data-message-id].flex.items-end.justify-start");if(!(e.length>0))return console.error("No AI bubble to update and no AI bubbles in chat (from WS message)."),void n(!1);{const t=e[e.length-1],s=t.dataset.messageId,o=getAIMessageLog(s);if(!o||o.isComplete||o.isStopped)return console.error("Cannot find a suitable AI bubble to update from WS message (last bubble completed/stopped)."),void n(!1);a=t,setCurrentAIBubble(a)}}const o=a.dataset.messageId;if(stoppedMessageIds.has(o))return;let r;try{r=JSON.parse(e.data)}catch(t){r={response:e.data,isFinal:!0},console.warn("Received non-JSON WebSocket message, treating as final response:",e.data)}s(a,r,o),chatWindowEl&&scrollToBottom(chatWindowEl)}function resumeHeavyDutyResearch(e,t){const s=loadHeavyDutyProgressForMessage(t);if(!s)return void alert("Could not find saved progress for this research task.");if(isAIResponding)return void alert("Another AI task is already in progress.");setAIResponding(!0),stoppedMessageIds.clear();const n=chatWindowEl.querySelector(`.message-container[data-message-id="${e}"]`);if(!n)return console.error("Could not find AI bubble to resume on UI for ID:",e),void setAIResponding(!1);{setCurrentAIBubble(n);const t=getAIMessageLog(e);t&&(t.isStopped=!1,t.isComplete=!1,t.fullThinkingLog=(t.fullThinkingLog||"")+"\nStatus: Resuming Heavy Duty Research...\n",updateAIMessageLog(e,t),updateAIBubble(n,{_isAIMessageObject:!0,...t},e))}const a={option:MODE_HEAVY_DUTY_DEEP_RESEARCH,prompts:s.originalPrompts,currentQuery:s.currentQuery,model:s.model,temperature:s.temperature,researchDepth:s.researchDepth,researchBreadth:s.researchBreadth,customSystemPrompt:s.customSystemPrompt,resumePayload:{heavyDutyResearchId:t,initialProcessedData:s.processedData||[],visitedUrls:s.visitedUrls||[],currentDepthToStartFrom:s.currentDepth||1},clientMessageId:e,clientSessionId:getCurrentSession()?.id};sendWsMessage(a)}export function addResumeButtonToMessage(e,t,s){if(!e||!s)return;let n=e.querySelector(".message-actions");if(!n){const s=e.querySelector(".flex.justify-between.items-center.mt-1");if(!s)return void console.warn("Message actions container (or meta div) not found for resume button on message:",t);n=document.createElement("div"),n.className="message-actions flex space-x-1",s.insertBefore(n,s.firstChild)}if(n.querySelector(".resume-hd-research-btn"))return;const a=document.createElement("button");a.title="Resume Heavy Duty Research",a.innerHTML=ICONS.resume||"Resume",a.className="resume-hd-research-btn p-1 hover:bg-slate-200 rounded flex items-center justify-center text-slate-500 hover:text-slate-700",a.dataset.messageId=t,a.dataset.researchId=s,n.insertBefore(a,n.firstChild)}window.addResumeButtonToMessage=addResumeButtonToMessage,window.utils={scrollToBottom:scrollToBottom},window.getIsAIResponding=getIsAIResponding,window.clearStoppedMessageIds=clearStoppedMessageIds,window.setCurrentAIBubble=setCurrentAIBubble,window.updateAIBubble=updateAIBubble;