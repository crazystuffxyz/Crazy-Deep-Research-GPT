import{generateUniqueId}from"./utils.js";import{showWelcomeMessage,clearChatWindow,appendMessageToChatWindow,setAIResponding}from"./uiManager.js";import{loadHeavyDutyProgressForMessage,clearHeavyDutyProgress}from"./heavyDutyResearchPersistence.js";export let sessions=[];export let currentSession=null;export let aiMessageLogStore={};let sessionListEl,noHistoryEl,chatWindowEl,userInputEl;export function initSessionManagerDOM(e){sessionListEl=e.sessionListEl,noHistoryEl=e.noHistoryEl,chatWindowEl=e.chatWindowEl,userInputEl=e.userInputEl}export function saveSessions(){localStorage.setItem("chatSessions",JSON.stringify(sessions))}export function renderSessions(){if(!sessionListEl||!noHistoryEl)return;sessionListEl.innerHTML="";const e=currentSession?currentSession.id:localStorage.getItem("currentSessionId");0!==sessions.length?(noHistoryEl.classList.add("hidden"),sessions.forEach((s=>{const t=document.createElement("div");t.className="session-item-container flex items-center group";const o=document.createElement("button");o.className="flex-grow text-left p-2.5 rounded-lg text-slate-700 truncate transition-colors text-sm",o.textContent=s.title||"Untitled Chat",s.id===e?o.classList.add("bg-slate-200","font-semibold"):o.classList.add("hover:bg-slate-100"),o.onclick=()=>{e===s.id||"function"==typeof window.getIsAIResponding&&window.getIsAIResponding()||loadSessionById(s.id)};const n=document.createElement("button");n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-slate-400 group-hover:text-red-500 hover:text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>',n.className="p-1.5 opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none",n.title="Delete Chat",n.onclick=e=>{e.stopPropagation(),"function"==typeof window.getIsAIResponding&&window.getIsAIResponding()?alert("Cannot delete chat while AI is responding."):confirm(`Are you sure you want to delete chat: "${s.title||"Untitled Chat"}"?`)&&deleteSession(s.id)},t.appendChild(o),t.appendChild(n),sessionListEl.appendChild(t)}))):noHistoryEl.classList.remove("hidden")}export function deleteSession(e){const s=sessions.find((s=>s.id===e));s&&s.messages&&s.messages.forEach((e=>{"ai"===e.role&&e.text?._isAIMessageObject?.heavyDutyResearchId&&clearHeavyDutyProgress(e.text.heavyDutyResearchId),delete aiMessageLogStore[e.id]})),sessions=sessions.filter((s=>s.id!==e)),saveSessions(),currentSession&&currentSession.id===e&&(currentSession=null,localStorage.removeItem("currentSessionId"),sessions.length>0?loadSessionById(sessions[0].id):createNewSession()),renderSessions()}export function loadSessionById(e){currentSession=sessions.find((s=>s.id===e))||null,clearChatWindow(),aiMessageLogStore={},"function"==typeof window.setCurrentAIBubble&&window.setCurrentAIBubble(null),setAIResponding(!1),"function"==typeof window.clearStoppedMessageIds&&window.clearStoppedMessageIds(),currentSession?.messages?.length>0?(showWelcomeMessage(!1),currentSession.messages.forEach((e=>{"ai"===e.role&&e.text&&e.text._isAIMessageObject&&(aiMessageLogStore[e.id]={fullThinkingLog:e.text.thinkingLog||"",finalResponse:e.text.finalResponse||"",lastStatus:"",isComplete:e.text.isComplete,isStopped:e.text.isStopped,originalStatusData:e.text.originalStatusData,heavyDutyResearchId:e.text.heavyDutyResearchId});const s=appendMessageToChatWindow(e.role,e.text,e.id,currentSession.id);if("ai"===e.role&&e.text?._isAIMessageObject?.heavyDutyResearchId&&!e.text.isComplete&&!e.text.isStopped){const t=loadHeavyDutyProgressForMessage(e.text.heavyDutyResearchId);t&&"function"==typeof window.addResumeButtonToMessage&&window.addResumeButtonToMessage(s,e.id,e.text.heavyDutyResearchId,t)}})),chatWindowEl&&"function"==typeof window.utils?.scrollToBottom&&window.utils.scrollToBottom(chatWindowEl)):showWelcomeMessage(!0),localStorage.setItem("currentSessionId",e),renderSessions(),userInputEl&&userInputEl.focus()}export function createNewSession(){if("function"==typeof window.getIsAIResponding&&window.getIsAIResponding())return void alert("Please wait for the current AI response to complete or stop it before starting a new chat.");const e=generateUniqueId(),s={id:e,title:"New Chat",messages:[]};sessions.unshift(s),localStorage.setItem("currentSessionId",e),saveSessions(),loadSessionById(e)}export function getCurrentSession(){return currentSession}export function updateCurrentSession(e){currentSession=e}export function getAIMessageLog(e){return aiMessageLogStore[e]}export function updateAIMessageLog(e,s){aiMessageLogStore[e]=s}export function initSessions(){sessions=JSON.parse(localStorage.getItem("chatSessions"))||[],sessions.forEach((e=>{e.messages&&e.messages.forEach((e=>{e.id||(e.id=generateUniqueId()),"ai"===e.role&&("string"==typeof e.text?e.text={_isAIMessageObject:!0,thinkingLog:e.text.startsWith("Error:")?e.text:"",finalResponse:e.text.startsWith("Error:")?"":e.text,isComplete:!0,isStopped:!1,originalStatusData:null}:e.text&&void 0===e.text._isAIMessageObject&&(e.text={_isAIMessageObject:!0,thinkingLog:e.text.thinking||"",finalResponse:e.text.response||"",isComplete:"boolean"!=typeof e.text.isComplete||e.text.isComplete,isStopped:e.text.isStopped||!1,originalStatusData:e.text.originalStatusData||null}),e.text&&e.text._isAIMessageObject&&(e.text.thinkingLog=e.text.thinkingLog||"",e.text.finalResponse=e.text.finalResponse||"","boolean"!=typeof e.text.isComplete&&(e.text.isComplete=!0),"boolean"!=typeof e.text.isStopped&&(e.text.isStopped=!1)))}))})),saveSessions();const e=localStorage.getItem("currentSessionId");e&&sessions.find((s=>s.id===e))?loadSessionById(e):sessions.length>0?loadSessionById(sessions[0].id):createNewSession()}