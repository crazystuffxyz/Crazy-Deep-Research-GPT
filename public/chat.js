import{ICONS,MODE_NORMAL,MODE_DEEP_THINK,MODE_SEARCH,MODE_SEARCH_DT,MODE_DEEP_RESEARCH_LITE,MODE_YOUTUBE_TRANSCRIPT,MODE_AUTO,MODE_HEAVY_DUTY_DEEP_RESEARCH,HEAVY_DUTY_RESEARCH_STORAGE_PREFIX}from"./js/constants.js";import{generateUniqueId,escapeHtml,extractYouTubeUrl}from"./js/utils.js";import{appSettings,initSettingsDOM,loadAppSettings,openSettingsModal}from"./js/settingsHandler.js";import{initSessionManagerDOM,saveSessions,renderSessions,createNewSession,getCurrentSession,updateCurrentSession,getAIMessageLog,updateAIMessageLog,initSessions}from"./js/sessionManager.js";import{connectWebSocket,getWs,sendWsMessage}from"./js/websocketClient.js";import{initUIManagerDOM,showWelcomeMessage,appendMessageToChatWindow,setAIResponding as setUIAIResponding,getCurrentAIBubble as getUICurrentAIBubble,setCurrentAIBubble as setUICurrentAIBubble,updateAIBubble as updateUIAIBubble}from"./js/uiManager.js";import{saveHeavyDutyProgress,loadHeavyDutyProgressForMessage}from"./js/heavyDutyResearchPersistence.js";function sendMessage(){const e=document.getElementById("user-input").value.trim(),t=getWs();if(!e||!t||t.readyState!==WebSocket.OPEN||window.getIsAIResponding())return;setUIAIResponding(!0),window.clearStoppedMessageIds();const s=getCurrentSession();if(!s)return console.error("No current session to send message to."),void setUIAIResponding(!1);const n=generateUniqueId();appendMessageToChatWindow("user",e,n,s.id),s.messages.push({id:n,role:"user",text:e}),"New Chat"!==s.title&&s.title||(s.title=e.slice(0,30)+(e.length>30?"...":""),renderSessions());const o=generateUniqueId(),l=appendMessageToChatWindow("ai",{thinking:"Initializing...",response:""},o,s.id);setUICurrentAIBubble(l);let i=null;const a=parseInt(document.getElementById("mode-select").value,10);a===MODE_HEAVY_DUTY_DEEP_RESEARCH&&(i=`${HEAVY_DUTY_RESEARCH_STORAGE_PREFIX}${s.id}-${o}`),s.messages.push({id:o,role:"ai",text:{_isAIMessageObject:!0,thinkingLog:"Initializing...",finalResponse:"",isComplete:!1,isStopped:!1,originalStatusData:null,heavyDutyResearchId:i}}),saveSessions();const r=document.getElementById("user-input");r.value="",r.style.height="auto",r.dispatchEvent(new Event("input")),document.getElementById("sendBtn").disabled=!0,r.focus();let d=appSettings.primaryModel,E=parseFloat(appSettings.primaryModelTemp);a!==MODE_DEEP_THINK&&a!==MODE_SEARCH_DT&&a!==MODE_YOUTUBE_TRANSCRIPT&&a!==MODE_AUTO&&a!==MODE_DEEP_RESEARCH_LITE&&a!==MODE_HEAVY_DUTY_DEEP_RESEARCH||(appSettings.auxModel&&(d=appSettings.auxModel),E=parseFloat(appSettings.auxModelTemp));const u=s.messages.filter((e=>e.id!==o)).map((e=>{let t="";const s=e.text;if("user"===e.role)t="string"==typeof s?s:"";else if("ai"===e.role)if("object"==typeof s&&null!==s&&s._isAIMessageObject){if(!s.isComplete||s.isStopped)return null;t=s.finalResponse||""}else{if("string"!=typeof s)return null;t=s}return{role:e.role,content:t}})).filter((e=>e&&"string"==typeof e.content&&""!==e.content.trim())),m={option:a,prompts:u,currentQuery:e,model:d||null,temperature:isNaN(E)?null:E,researchDepth:a===MODE_DEEP_RESEARCH_LITE||a===MODE_HEAVY_DUTY_DEEP_RESEARCH?parseInt(appSettings.researchDepth):void 0,researchBreadth:a===MODE_DEEP_RESEARCH_LITE||a===MODE_HEAVY_DUTY_DEEP_RESEARCH?parseInt(appSettings.researchBreadth):void 0,customSystemPrompt:appSettings.customSystemPrompt||null,youtubeUrl:a===MODE_YOUTUBE_TRANSCRIPT?extractYouTubeUrl(e):null,clientMessageId:o,clientSessionId:s.id};a===MODE_HEAVY_DUTY_DEEP_RESEARCH&&i&&saveHeavyDutyProgress(i,{originalPrompts:u,currentQuery:e,model:d||null,temperature:isNaN(E)?null:E,researchDepth:parseInt(appSettings.researchDepth),researchBreadth:parseInt(appSettings.researchBreadth),customSystemPrompt:appSettings.customSystemPrompt||null,processedData:[],visitedUrls:[],currentDepth:1}),sendWsMessage(m)}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("sessionList"),t=document.getElementById("no-history"),s=document.getElementById("chat-window"),n=document.getElementById("welcome-message"),o=document.getElementById("user-input"),l=document.getElementById("sendBtn"),i=document.getElementById("newChatBtn"),a=document.getElementById("mode-select"),r=document.getElementById("ai-message-template"),d=document.getElementById("settingsBtn"),E=document.getElementById("settingsModal"),u=document.getElementById("closeSettingsModal"),m=document.getElementById("primary-model-selector"),p=document.getElementById("primary-model-temp"),g=document.getElementById("aux-model-selector"),c=document.getElementById("aux-model-temp"),I=document.getElementById("research-depth"),S=document.getElementById("research-breadth"),M=document.getElementById("custom-system-prompt"),y=document.getElementById("websocket-concurrency"),D=document.getElementById("pull-model-name"),_=document.getElementById("pullModelBtn"),B=document.getElementById("pull-status"),h=document.getElementById("available-models-list"),A=document.getElementById("saveSettingsBtn");initSettingsDOM({primaryModelSelectorEl:m,primaryModelTempEl:p,auxModelSelectorEl:g,auxModelTempEl:c,researchDepthEl:I,researchBreadthEl:S,customSystemPromptEl:M,websocketConcurrencyEl:y,settingsModal:E,closeSettingsModalBtn:u,saveSettingsBtn:A,pullModelNameInputEl:D,pullModelBtnEl:_,pullStatusEl:B,availableModelsListEl:h}),initSessionManagerDOM({sessionListEl:e,noHistoryEl:t,chatWindowEl:s,userInputEl:o}),initUIManagerDOM({chatWindowEl:s,welcomeMessageEl:n,userInputEl:o,sendBtnEl:l,modeSelectEl:a,aiMessageTemplate:r,primaryModelSelectorEl:m,auxModelSelectorEl:g,availableModelsListEl:h}),loadAppSettings(),initSessions(),connectWebSocket(window.getIsAIResponding,getUICurrentAIBubble,updateUIAIBubble,setUIAIResponding),l&&l.addEventListener("click",sendMessage),i&&i.addEventListener("click",createNewSession),d&&d.addEventListener("click",openSettingsModal),o&&(o.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),l.disabled||sendMessage())})),o.addEventListener("input",(()=>{o.style.height="auto",o.style.height=`${Math.min(o.scrollHeight,180)}px`,window.getIsAIResponding()||(l.disabled=""===o.value.trim())})),o.dispatchEvent(new Event("input"))),setUIAIResponding(!1),renderSessions()}));