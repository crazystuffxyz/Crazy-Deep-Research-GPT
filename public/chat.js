import{MODE_DEEP_THINK,MODE_SEARCH_DT,MODE_YOUTUBE_TRANSCRIPT,MODE_AUTO,MODE_DEEP_RESEARCH_LITE,MODE_HEAVY_DUTY_DEEP_RESEARCH,HEAVY_DUTY_RESEARCH_STORAGE_PREFIX}from"./js/constants.js";import{generateUniqueId,extractYouTubeUrl}from"./js/utils.js";import{appSettings,initSettingsDOM,loadAppSettings,openSettingsModal}from"./js/settingsHandler.js";import{initSessionManagerDOM,saveSessions,renderSessions,createNewSession,getCurrentSession,initSessions}from"./js/sessionManager.js";import{connectWebSocket,getWs,sendWsMessage}from"./js/websocketClient.js";import{initUIManagerDOM,appendMessageToChatWindow,setAIResponding as setUIAIResponding,getCurrentAIBubble as getUICurrentAIBubble,setCurrentAIBubble as setUICurrentAIBubble,updateAIBubble as updateUIAIBubble}from"./js/uiManager.js";import{saveHeavyDutyProgress}from"./js/heavyDutyResearchPersistence.js";function sendMessage(){const e=document.getElementById("user-input"),t=e.value.trim(),n=getWs();if(!t||!n||n.readyState!==WebSocket.OPEN||"function"==typeof window.getIsAIResponding&&window.getIsAIResponding())return;setUIAIResponding(!0),"function"==typeof window.clearStoppedMessageIds&&window.clearStoppedMessageIds();const s=getCurrentSession();if(!s)return console.error("No current session to send message to."),void setUIAIResponding(!1);const o=generateUniqueId();appendMessageToChatWindow("user",t,o,s.id),s.messages.push({id:o,role:"user",text:t}),"New Chat"!==s.title&&s.title||(s.title=t.slice(0,30)+(t.length>30?"...":""),renderSessions());const i=generateUniqueId(),l=appendMessageToChatWindow("ai",{thinking:"Initializing...",response:""},i,s.id);setUICurrentAIBubble(l);let r=null;const a=parseInt(document.getElementById("mode-select").value,10);a===MODE_HEAVY_DUTY_DEEP_RESEARCH&&(r=`${s.id}-${i}`),s.messages.push({id:i,role:"ai",text:{_isAIMessageObject:!0,thinkingLog:"Initializing...",finalResponse:"",isComplete:!1,isStopped:!1,originalStatusData:null,heavyDutyResearchId:r}}),saveSessions(),e.value="",e.style.height="auto",e.dispatchEvent(new Event("input")),document.getElementById("sendBtn").disabled=!0,e.focus();let d=appSettings.primaryModel,E=parseFloat(appSettings.primaryModelTemp);[MODE_DEEP_THINK,MODE_SEARCH_DT,MODE_YOUTUBE_TRANSCRIPT,MODE_AUTO,MODE_DEEP_RESEARCH_LITE,MODE_HEAVY_DUTY_DEEP_RESEARCH].includes(a)&&(appSettings.auxModel&&(d=appSettings.auxModel),E=parseFloat(appSettings.auxModelTemp));const u=s.messages.filter((e=>e.id!==i)).map((e=>{let t="";const n=e.text;if("user"===e.role)t="string"==typeof n?n:"";else if("ai"===e.role)if("object"==typeof n&&null!==n&&n._isAIMessageObject){if(!n.isComplete||n.isStopped)return null;t=n.finalResponse||""}else{if("string"!=typeof n)return null;t=n}return{role:e.role,content:t}})).filter((e=>e&&"string"==typeof e.content&&""!==e.content.trim())),p={option:a,prompts:u,currentQuery:t,model:d||null,temperature:isNaN(E)?null:E,researchDepth:a===MODE_DEEP_RESEARCH_LITE||a===MODE_HEAVY_DUTY_DEEP_RESEARCH?parseInt(appSettings.researchDepth):void 0,researchBreadth:a===MODE_DEEP_RESEARCH_LITE||a===MODE_HEAVY_DUTY_DEEP_RESEARCH?parseInt(appSettings.researchBreadth):void 0,customSystemPrompt:appSettings.customSystemPrompt||null,youtubeUrl:a===MODE_YOUTUBE_TRANSCRIPT?extractYouTubeUrl(t):null,clientMessageId:i,clientSessionId:s.id};a===MODE_HEAVY_DUTY_DEEP_RESEARCH&&r&&saveHeavyDutyProgress(r,{originalPrompts:u,currentQuery:t,model:d||null,temperature:isNaN(E)?null:E,researchDepth:parseInt(appSettings.researchDepth),researchBreadth:parseInt(appSettings.researchBreadth),customSystemPrompt:appSettings.customSystemPrompt||null,processedData:[],visitedUrls:[],currentDepth:1}),sendWsMessage(p)}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("sessionList"),t=document.getElementById("no-history"),n=document.getElementById("chat-window"),s=document.getElementById("welcome-message"),o=document.getElementById("user-input"),i=document.getElementById("sendBtn"),l=document.getElementById("newChatBtn"),r=document.getElementById("mode-select"),a=document.getElementById("ai-message-template"),d=document.getElementById("settingsBtn"),E=document.getElementById("settingsModal"),u=document.getElementById("closeSettingsModal"),p=document.getElementById("primary-model-selector"),m=document.getElementById("primary-model-temp"),c=document.getElementById("aux-model-selector"),g=document.getElementById("aux-model-temp"),I=document.getElementById("research-depth"),S=document.getElementById("research-breadth"),M=document.getElementById("custom-system-prompt"),y=document.getElementById("websocket-concurrency"),D=document.getElementById("pull-model-name"),h=document.getElementById("pullModelBtn"),_=document.getElementById("pull-status"),B=document.getElementById("available-models-list"),A=document.getElementById("saveSettingsBtn");if(!n)return console.error("FATAL: chat.js - DOMContentLoaded - chat-window element NOT FOUND. UI will not work."),void alert("Error: Core chat UI element missing. Please check console and HTML.");initSettingsDOM({primaryModelSelectorEl:p,primaryModelTempEl:m,auxModelSelectorEl:c,auxModelTempEl:g,researchDepthEl:I,researchBreadthEl:S,customSystemPromptEl:M,websocketConcurrencyEl:y,settingsModal:E,closeSettingsModalBtn:u,saveSettingsBtn:A,pullModelNameInputEl:D,pullModelBtnEl:h,pullStatusEl:_,availableModelsListEl:B}),initSessionManagerDOM({sessionListEl:e,noHistoryEl:t,chatWindowEl:n,userInputEl:o}),initUIManagerDOM({chatWindowEl:n,welcomeMessageEl:s,userInputEl:o,sendBtnEl:i,modeSelectEl:r,aiMessageTemplate:a,primaryModelSelectorEl:p,auxModelSelectorEl:c,availableModelsListEl:B}),loadAppSettings(),initSessions(),connectWebSocket(window.getIsAIResponding,getUICurrentAIBubble,updateUIAIBubble,setUIAIResponding),i&&i.addEventListener("click",sendMessage),l&&l.addEventListener("click",createNewSession),d&&d.addEventListener("click",openSettingsModal),o&&(o.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),i.disabled||sendMessage())})),o.addEventListener("input",(()=>{o.style.height="auto",o.style.height=`${Math.min(o.scrollHeight,180)}px`,"function"!=typeof window.getIsAIResponding||window.getIsAIResponding()||(i.disabled=""===o.value.trim())})),o.dispatchEvent(new Event("input"))),setUIAIResponding(!1),renderSessions()}));