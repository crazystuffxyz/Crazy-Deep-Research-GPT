import axios from"axios";import{JSDOM}from"jsdom";import{Readability}from"@mozilla/readability";import*as cheerio from"cheerio";function formatDate(e){if(!e)return"n.d.";const t=new Date(e);return isNaN(t)?"n.d.":t.toISOString().split("T")[0]}function formatCitations(e){const{author:t,title:a,year:r,site:i,url:n,accessed:o}=e,c="Unknown Author"===t?"":t;return{APA:`${c} (${r}). *${a}*. ${i}. ${n}`,MLA:`${c}. "${a}." *${i}*, ${r}, ${n}. Accessed ${o}.`,Chicago:`${c}. "${a}." *${i}*, ${r}. Accessed ${o}. ${n}.`,Harvard:`${c}, ${r}. *${a}*, ${i}. Available at: ${n} (Accessed: ${o}).`,Vancouver:`${c}. ${a} [Internet]. ${r} [cited ${o}]. Available from: ${n}`,IEEE:`${c}, "${a}," *${i}*, ${r}. [Online]. Available: ${n}. [Accessed: ${o}].`,Bluebook:`${c}, *${a}*, ${i} (${r}), available at ${n} (last visited ${o}).`,ACS:`${c}. ${a}. ${i} ${r}. ${n} (accessed ${o}).`,AMA:`${c}. ${a}. ${i}. Published ${r}. Accessed ${o}. ${n}`,Turabian:`${c}. "${a}." *${i}*, ${r}. Accessed ${o}. ${n}.`}}export async function generateCitation(e){if(!e||"string"!=typeof e)return{error:"Invalid URL provided. URL must be a non-empty string."};try{new URL(e)}catch(t){return{error:`Invalid URL format: ${e}. ${t.message}`}}try{const t=(await axios.get(e,{headers:{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"en-US,en;q=0.9",dnt:"1",priority:"u=0, i","sec-ch-ua":'"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"none","sec-fetch-user":"?1","upgrade-insecure-requests":"1","user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36"},timeout:15e3})).data,a=cheerio.load(t);a('script, style, iframe, aside, noscript, form, .ads, .advertisement, [aria-hidden="true"]').remove(),a("img").each(((e,t)=>{const r=a(t).attr("alt")||"Image";a(t).replaceWith(`<p>[Image: ${r}]</p>`)}));const r=a.html(),i=new JSDOM(r,{url:e}),n=new Readability(i.window.document).parse(),o=cheerio.load(t),c=n?.byline||o('meta[name="author"]').attr("content")||o('meta[property="article:author"]').attr("content")||o('[class*="author"], [id*="author"], [class*="byline"], [id*="byline"]').first().text().trim()||"Unknown Author",s=n?.title||o('meta[property="og:title"]').attr("content")||o("title").first().text().trim()||"Untitled",m=o('meta[property="article:published_time"]').attr("content")||o('meta[name="date"]').attr("content")||o("time[datetime]").attr("datetime")||n?.publishedTime||null,l=m?new Date(m).getFullYear():"n.d.",$=isNaN(parseInt(l))?"n.d.":parseInt(l),d=n?.siteName||o('meta[property="og:site_name"]').attr("content")||new URL(e).hostname,p=formatDate(new Date),u={author:c.replace(/\s+/g," ").trim(),title:s.replace(/\s+/g," ").trim(),year:$,site:d.replace(/\s+/g," ").trim(),url:e,accessed:p,rawDate:m||"n.d.",excerpt:n?.excerpt||o('meta[name="description"]').attr("content")||"",content:n?.textContent||""};return{citations:formatCitations(u),data:u}}catch(t){return{error:`Failed to extract citation from ${e}: ${t.message}`}}}